# WebSocket Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Bus Ticketing Platform                       │
│                                                                       │
│  ┌──────────────┐         ┌──────────────┐        ┌──────────────┐ │
│  │   Client A   │         │   Client B   │        │   Client C   │ │
│  │  (Browser)   │         │  (Browser)   │        │   (Mobile)   │ │
│  └──────┬───────┘         └──────┬───────┘        └──────┬───────┘ │
│         │                        │                        │          │
│         │ WebSocket              │ WebSocket              │ WebSocket│
│         └────────────┬───────────┴────────────┬───────────┘          │
│                      │                        │                      │
│              ┌───────▼────────────────────────▼───────┐              │
│              │   WebSocket Gateway (/seats)           │              │
│              │                                         │              │
│              │  Rooms:                                 │              │
│              │  • route:uuid-1 → [Client A, Client B] │              │
│              │  • route:uuid-2 → [Client C]           │              │
│              └───────┬────────────────────────┬───────┘              │
│                      │                        │                      │
│         ┌────────────┴────────┐   ┌──────────┴────────┐             │
│         │                     │   │                    │             │
│    ┌────▼─────┐        ┌─────▼───▼─────┐      ┌──────▼──────┐      │
│    │  Ticket  │        │    Payment     │      │    Route    │      │
│    │ Service  │        │    Service     │      │   Service   │      │
│    └────┬─────┘        └─────┬──────────┘      └─────────────┘      │
│         │                    │                                       │
│         └────────────────────┴───────────┐                           │
│                                          │                           │
│                                   ┌──────▼──────┐                    │
│                                   │   Prisma    │                    │
│                                   │  (Database) │                    │
│                                   └─────────────┘                    │
└───────────────────────────────────────────────────────────────────────┘
```

## Event Flow Diagram

### Scenario: User Books a Ticket

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│Client A │     │Client B │     │  REST   │     │ Ticket  │     │WebSocket│
│(Viewer) │     │(Booker) │     │   API   │     │ Service │     │ Gateway │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │               │
     │ subscribe_route               │               │               │
     ├──────────────────────────────────────────────────────────────►│
     │               │               │               │               │
     │               POST /tickets   │               │               │
     │               ├──────────────►│               │               │
     │               │               │ create()      │               │
     │               │               ├──────────────►│               │
     │               │               │               │ Save to DB    │
     │               │               │               ├──────────────►│
     │               │               │               │               │
     │               │               │  emitSeatReserved()           │
     │               │               │               ├──────────────►│
     │               │               │               │               │
     │ seat_update   │               │               │  to room:route│
     │◄──────────────┼───────────────┼───────────────┼───────────────┤
     │               │               │               │               │
     │ seat_update   │               │               │               │
     │               ◄───────────────┼───────────────┼───────────────┤
     │               │               │               │               │
     │               │ 200 OK        │               │               │
     │               │◄──────────────┤               │               │
     │               │               │               │               │
     └───────────────┴───────────────┴───────────────┴───────────────┘
```

## Payment Flow with WebSocket

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│Client A │     │Client B │     │ Payment │     │ Ticket  │     │WebSocket│
│(Viewer) │     │(Payer)  │     │ Service │     │ Gateway │     │ Gateway │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │               │
     │               POST /payments  │               │               │
     │               ├──────────────►│               │               │
     │               │               │ Validate      │               │
     │               │               │ ticket        │               │
     │               │               ├──────────────►│               │
     │               │               │               │               │
     │               │               │ Process       │               │
     │               │               │ payment       │               │
     │               │               │ (iyzico/mock) │               │
     │               │               ├───────┐       │               │
     │               │               │       │       │               │
     │               │               │◄──────┘       │               │
     │               │               │               │               │
     │               │               │ Update ticket │               │
     │               │               │ status=CONFIRMED              │
     │               │               ├──────────────►│               │
     │               │               │               │               │
     │               │        emitSeatConfirmed()    │               │
     │               │               ├───────────────────────────────►│
     │               │               │               │               │
     │ seat_update   │               │               │ to room:route │
     │◄──────────────┼───────────────┼───────────────┼───────────────┤
     │ (CONFIRMED)   │               │               │               │
     │               │               │               │               │
     │               │ seat_update   │               │               │
     │               │◄──────────────┼───────────────┼───────────────┤
     │               │ (CONFIRMED)   │               │               │
     │               │               │               │               │
     │               │ 200 OK        │               │               │
     │               │ Payment Success                               │
     │               │◄──────────────┤               │               │
     │               │               │               │               │
     └───────────────┴───────────────┴───────────────┴───────────────┘
```

## Cancellation Flow with WebSocket

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│Client A │     │Client B │     │ Ticket  │     │WebSocket│
│(Viewer) │     │(Owner)  │     │ Service │     │ Gateway │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │               DELETE /tickets/:id             │
     │               ├──────────────►│               │
     │               │               │ Validate      │
     │               │               │ ownership     │
     │               │               ├───────┐       │
     │               │               │       │       │
     │               │               │◄──────┘       │
     │               │               │               │
     │               │               │ Update status │
     │               │               │ =CANCELLED    │
     │               │               ├──────────────►│
     │               │               │               │
     │               │        emitSeatCancelled()    │
     │               │               ├──────────────►│
     │               │               │               │
     │ seat_update   │               │               │
     │◄──────────────┼───────────────┼───────────────┤
     │ (CANCELLED)   │               │               │
     │               │               │               │
     │               │        emitSeatAvailable()    │
     │               │               ├──────────────►│
     │               │               │               │
     │ seat_update   │               │               │
     │◄──────────────┼───────────────┼───────────────┤
     │ (AVAILABLE)   │               │               │
     │               │               │               │
     │               │ seat_update   │               │
     │               │◄──────────────┼───────────────┤
     │               │ (CANCELLED)   │               │
     │               │               │               │
     │               │ seat_update   │               │
     │               │◄──────────────┼───────────────┤
     │               │ (AVAILABLE)   │               │
     │               │               │               │
     │               │ 200 OK        │               │
     │               │◄──────────────┤               │
     │               │               │               │
     └───────────────┴───────────────┴───────────────┘
```

## Room-Based Subscription Architecture

```
┌───────────────────────────────────────────────────────────────────┐
│                     WebSocket Gateway                              │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  Room: "route:550e8400-e29b-41d4-a716-446655440000"      │    │
│  │                                                           │    │
│  │  Connected Clients:                                       │    │
│  │  ├─ socket-abc123 (Client A - viewing Istanbul→Ankara)   │    │
│  │  ├─ socket-def456 (Client B - booking ticket)            │    │
│  │  └─ socket-ghi789 (Client C - admin monitoring)          │    │
│  │                                                           │    │
│  │  When event occurs (seat 15 reserved):                   │    │
│  │  ➤ All 3 clients receive notification immediately        │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  Room: "route:660e8400-e29b-41d4-a716-446655440001"      │    │
│  │                                                           │    │
│  │  Connected Clients:                                       │    │
│  │  ├─ socket-jkl012 (Client D - viewing Ankara→Izmir)      │    │
│  │  └─ socket-mno345 (Client E - customer support)          │    │
│  │                                                           │    │
│  │  When event occurs (seat 8 cancelled):                   │    │
│  │  ➤ Only these 2 clients receive notification             │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  Room: "route:770e8400-e29b-41d4-a716-446655440002"      │    │
│  │                                                           │    │
│  │  Connected Clients:                                       │    │
│  │  └─ socket-pqr678 (Client F - mobile app)                │    │
│  │                                                           │    │
│  │  When event occurs (seat 20 confirmed):                  │    │
│  │  ➤ Only this client receives notification                │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## Event Types State Machine

```
                    ┌─────────────┐
                    │  AVAILABLE  │
                    │  (Initial)  │
                    └──────┬──────┘
                           │
                    POST /tickets
                           │
                           ▼
                    ┌─────────────┐
             ┌──────┤   RESERVED  ├──────┐
             │      │  (Unpaid)   │      │
             │      └──────┬──────┘      │
             │             │             │
             │      POST /payments       │
    Admin    │      (success)            │  DELETE /tickets
    suspend  │             │             │  (cancel)
             │             ▼             │
             │      ┌─────────────┐      │
             └─────►│  CONFIRMED  │      │
                    │   (Paid)    │◄─────┘
                    └──────┬──────┘
                           │
                           │ DELETE /tickets
                           │ (cancel + refund)
                           ▼
                    ┌─────────────┐
              ┌────►│  CANCELLED  │
              │     └──────┬──────┘
              │            │
    Admin     │            │ Automatically
    suspend   │            │ emits AVAILABLE
              │            │ event
              │            ▼
              │     ┌─────────────┐
              │     │  AVAILABLE  │
              │     │  (Reopened) │
              │     └─────────────┘
              │
       ┌──────┴──────┐
       │  SUSPENDED  │
       │  (Admin)    │
       └─────────────┘
```

## Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Frontend Layer                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐         │
│  │  Seat Map    │    │  Booking     │    │  Admin       │         │
│  │  Component   │    │  Form        │    │  Dashboard   │         │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘         │
│         │                   │                   │                  │
│         │ Subscribe         │ Book Ticket       │ Manage           │
│         │ to Route          │                   │ Tickets          │
│         │                   │                   │                  │
└─────────┼───────────────────┼───────────────────┼──────────────────┘
          │                   │                   │
          │ WebSocket         │ REST API          │ REST API
          │                   │                   │
┌─────────┼───────────────────┼───────────────────┼──────────────────┐
│         │                   │                   │                  │
│         ▼                   ▼                   ▼                  │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐        │
│  │  WebSocket   │    │   Ticket     │    │   Payment    │        │
│  │   Gateway    │◄───┤  Controller  │◄───┤  Controller  │        │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘        │
│         │                   │                   │                  │
│         │ Emit Events       │                   │                  │
│         │◄──────────────────┼───────────────────┤                  │
│         │                   │                   │                  │
│         │            ┌──────▼───────┐    ┌──────▼───────┐         │
│         │            │   Ticket     │    │   Payment    │         │
│         │            │   Service    │    │   Service    │         │
│         │            └──────┬───────┘    └──────┬───────┘         │
│         │                   │                   │                  │
│         │                   └───────────┬───────┘                  │
│         │                               │                          │
│         │                        ┌──────▼───────┐                  │
│         │                        │    Prisma    │                  │
│         │                        │   Service    │                  │
│         │                        └──────┬───────┘                  │
│         │                               │                          │
└─────────┼───────────────────────────────┼──────────────────────────┘
          │                               │
          │ Real-time Events              │ Database Operations
          │                               │
┌─────────┼───────────────────────────────┼──────────────────────────┐
│         │                               │                          │
│         ▼                               ▼                          │
│  ┌──────────────┐              ┌──────────────┐                   │
│  │   Connected  │              │  PostgreSQL  │                   │
│  │   Clients    │              │   Database   │                   │
│  └──────────────┘              └──────────────┘                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

## Scalability Architecture (Production)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Load Balancer                               │
└────┬───────────────────┬───────────────────┬─────────────────────┬──┘
     │                   │                   │                     │
┌────▼─────┐       ┌─────▼────┐       ┌─────▼────┐       ┌───────▼───┐
│ Server 1 │       │ Server 2 │       │ Server 3 │       │ Server N  │
│          │       │          │       │          │       │           │
│ WS + API │       │ WS + API │       │ WS + API │       │ WS + API  │
└────┬─────┘       └─────┬────┘       └─────┬────┘       └───────┬───┘
     │                   │                   │                     │
     └───────────────────┴───────────────────┴─────────────────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  Redis Adapter  │
                         │  (Pub/Sub)      │
                         └────────┬────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
              ┌─────▼──────┐            ┌──────▼──────┐
              │ PostgreSQL │            │   Redis     │
              │ (Primary)  │            │   (Cache)   │
              └────────────┘            └─────────────┘
```

## Error Handling Flow

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│ Client  │     │ Gateway │     │ Service │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     │ subscribe_route               │
     │ (invalid data)│               │
     ├──────────────►│               │
     │               │ Validate      │
     │               ├───────┐       │
     │               │       │       │
     │               │◄──────┘       │
     │               │ Invalid       │
     │               │               │
     │ error event   │               │
     │◄──────────────┤               │
     │ { message: "Route ID required" }
     │               │               │
     │ subscribe_route               │
     │ (valid data)  │               │
     ├──────────────►│               │
     │               │ Join room     │
     │               ├───────┐       │
     │               │       │       │
     │               │◄──────┘       │
     │               │               │
     │ subscribed    │               │
     │◄──────────────┤               │
     │ { routeId, message }          │
     │               │               │
     └───────────────┴───────────────┘
```

## Monitoring Dashboard (Conceptual)

```
┌─────────────────────────────────────────────────────────────────────┐
│                    WebSocket Monitoring Dashboard                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Active Connections: 1,234                                          │
│  Total Routes Subscribed: 87                                        │
│  Events/Second: 45                                                  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Top Active Routes                                            │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │  Istanbul → Ankara          156 subscribers  ████████████    │  │
│  │  Ankara → Izmir             98 subscribers   ███████          │  │
│  │  Izmir → Antalya            72 subscribers   █████            │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Event Distribution (Last Hour)                               │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │  SEAT_RESERVED      2,345  ███████████████                   │  │
│  │  SEAT_CONFIRMED     1,890  ████████████                      │  │
│  │  SEAT_CANCELLED       234  ██                                │  │
│  │  SEAT_SUSPENDED        45  █                                 │  │
│  │  SEAT_AVAILABLE       189  ██                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  Connection Health                                            │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │  Avg Latency:  12ms   ✓ Healthy                              │  │
│  │  Uptime:      99.9%   ✓ Healthy                              │  │
│  │  Error Rate:   0.1%   ✓ Healthy                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

---

**All diagrams are text-based for easy version control and documentation.**

**For interactive/visual diagrams, consider tools like:**
- draw.io
- Lucidchart
- Mermaid.js (with proper styling disabled)
